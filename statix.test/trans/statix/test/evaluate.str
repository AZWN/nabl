module statix/test/evaluate

imports

  nabl2/api
  
  signatures/statix/lang/-
  statix/lang/-
  statix/lang/statics/-

  signatures/statix/test/-
  pp/statix/test/-
  statix/test/-
  
  statixruntime

signature
  constructors
    SUCCEEDS : TestResult
    FAILS    : TestResult

rules
  
  editor-evaluate:
    (_, _, ast, path, project-path) -> (filename, result)
    with a := <nabl2-get-resource-analysis> $[[project-path]/[path]]
       ; (ast', _) := <nabl2-get-custom-analysis> a
       ; result := <evaluate;pp-Statix-string(prettyprint-Statix-TestResult)> ast'
       ; filename := <guarantee-extension(|"stxresult")> path

  evaluate-test: ast -> result
    with a := <nabl2-get-ast-analysis> ast
       ; (ast', _) := <nabl2-get-custom-analysis> a
       ; if (_, [], _, _) := <evaluate> ast' then
           result := SUCCEEDS()
         else
           result := FAILS()
         end

  evaluate: ast@Test(bvs, body, _) -> result
    with a := <nabl2-get-ast-analysis> ast
       ; spec := <nabl2-get-custom-analysis;strip-annos;eliminate-all;spec-ast-to-aterm> a
       ; result := <stx--solve-constraint(|spec)> (bvs, body)
